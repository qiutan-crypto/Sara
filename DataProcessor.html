<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Payroll + W2 Name-Matching Extractor</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
</script>

<style>
:root {
    font-family: "Segoe UI", Arial, sans-serif;
    color: #1f2d3d;
    background: #f5f7fb;
}

body {
    margin: 0;
    background: #f5f7fb;
}

.app {
    max-width: 1100px;
    margin: 0 auto;
    padding: 32px 24px 48px;
}

h1 {
    margin-bottom: 0;
}

header p {
    color: #5c6672;
    margin-top: 6px;
    margin-bottom: 24px;
}

.card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
}

.card {
    background: #fff;
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(31, 45, 61, 0.08);
    border: 1px solid #e8edf4;
}

.card h3 {
    margin-top: 0;
    margin-bottom: 10px;
}

.card p {
    margin-top: 0;
    color: #6a7381;
    font-size: 0.95rem;
}

.file-name {
    font-weight: 600;
    color: #1f2d3d;
    background: #f8fafc;
    border: 1px solid #e0e6f3;
    border-radius: 8px;
    padding: 10px 14px;
    margin-bottom: 12px;
    min-height: 22px;
}

.file-label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: 1px dashed #9ba9c4;
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    color: #1f4bd8;
    background: #f0f4ff;
    margin-top: 10px;
}

.file-input {
    display: none;
}

.extract-btn {
    border: none;
    color: #fff;
    background: linear-gradient(120deg, #4f46e5, #667eea);
    padding: 14px 26px;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 12px 20px rgba(79, 70, 229, 0.25);
}

.extract-btn:hover {
    transform: translateY(-1px);
}

.export-btn {
    border: none;
    color: #394561;
    background: #e0e7ff;
    padding: 14px 22px;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    margin-left: 12px;
}

.action-row {
    margin-top: 24px;
    display: flex;
    flex-wrap: wrap;
}

.status-grid {
    margin-top: 24px;
    display: grid;
    grid-template-columns: 1fr;
}

.log-card pre {
    background: #0e1117;
    color: #a8ffb0;
    border-radius: 10px;
    padding: 18px;
    margin: 0;
    max-height: 200px;
    overflow: auto;
    font-size: 0.95rem;
}

.table-card {
    margin-top: 24px;
    overflow: hidden;
    padding: 0;
}

.table-card header,
.log-card header {
    padding: 16px 20px 0;
}

.table-wrapper {
    overflow-x: auto;
    padding: 0 20px 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
    font-size: 0.95rem;
}

th {
    background: #eef2ff;
    text-align: left;
    padding: 10px;
    font-weight: 600;
    border-bottom: 2px solid #d7dcf4;
}

td {
    border-bottom: 1px solid #f0f1f6;
    padding: 10px;
}

tbody tr:nth-child(odd) {
    background: #fafbff;
}

td input[type="text"] {
    width: 100%;
    border: 1px solid #d5daec;
    border-radius: 6px;
    padding: 6px 8px;
    font-family: inherit;
}

tfoot {
    background: #fef9ef;
    font-weight: 700;
}

.totals-row td {
    border-top: 2px solid #f5d38c;
}

@media (max-width: 600px) {
    .app {
        padding: 20px 16px 40px;
    }

    th, td {
        font-size: 0.85rem;
    }
}
</style>
</head>

<body>
<div class="app">

<header>
    <h1>Payroll + W-2 Name-Matching Extractor</h1>
    <p>Upload a payroll summary and W-2 PDFs to pair employees with their SSNs and California wage data.</p>
</header>

<section class="card-grid">
    <div class="card">
        <h3>Payroll PDF</h3>
        <p class="file-name" id="payrollFileName">No file selected</p>
        <input type="file" id="payrollPDF" accept="application/pdf" class="file-input">
        <label class="file-label" for="payrollPDF">
            <span>Select Payroll PDF</span>
        </label>
    </div>

    <div class="card">
        <h3>W-2 PDF</h3>
        <p class="file-name" id="w2FileName">No file selected</p>
        <input type="file" id="w2PDF" accept="application/pdf" class="file-input">
        <label class="file-label" for="w2PDF">
            <span>Select W-2 PDF</span>
        </label>
    </div>
</section>

<div class="action-row">
    <button class="extract-btn" onclick="extractAll()">Run Extraction</button>
    <button class="export-btn" onclick="exportCSV()">Export CSV</button>
</div>

<section class="status-grid">
    <div class="card log-card">
        <header>
            <h3>Activity Log</h3>
        </header>
        <pre id="log"></pre>
    </div>
</section>

<section class="card table-card">
    <header>
        <h3>Matched Employees</h3>
    </header>
    <div class="table-wrapper">
        <table id="resultTable">
        <thead>
<tr>
    <th>SSN</th>
    <th>First Name</th>
    <th>Middle Name</th>
    <th>Last Name</th>
    <th>Total Subject Wages</th>
    <th>PIT Wages</th>
    <th>PIT Withheld</th>
</tr>
        </thead>
        <tbody></tbody>
        <tfoot>
        <tr class="totals-row">
            <td>Grand Totals</td>
            <td id="totalCount"></td>
            <td></td>
            <td></td>
            <td id="totalWages"></td>
            <td id="totalPitWages"></td>
            <td id="totalPitWithheld"></td>
        </tr>
        </tfoot>
        </table>
    </div>
</section>

</div>
<script>
let latestData = [];

// =========================
// Helpers
// =========================

function log(msg) {
    const logEl = document.getElementById("log");
    logEl.textContent += msg + "\n";
}

function cleanName(str) {
    return str
        .trim()
        .toLowerCase()
        .replace(/[.,]/g, "")
        .replace(/\s+/g, " ");
}

function formatSSN(value) {
    if (!value) return "";
    const digits = String(value).replace(/\D/g, "");
    if (digits.length === 9)
        return `${digits.slice(0,3)}-${digits.slice(3,5)}-${digits.slice(5)}`;
    return value;
}

function parseCurrency(value) {
    if (!value) return 0;
    const cleaned = String(value).replace(/[^0-9.-]/g, "");
    const number = parseFloat(cleaned);
    return Number.isNaN(number) ? 0 : number;
}

function formatCurrency(amount) {
    return amount.toLocaleString("en-US", { style: "currency", currency: "USD" });
}

function updateTotalsRow(totals) {
    document.getElementById("totalCount").textContent = `${totals.count} employees`;
    document.getElementById("totalWages").textContent = formatCurrency(totals.wages);
    document.getElementById("totalPitWages").textContent = formatCurrency(totals.pitWages);
    document.getElementById("totalPitWithheld").textContent = formatCurrency(totals.pitWithheld);
}

function nameTokenKey(str) {
    return cleanName(str)
        .split(" ")
        .filter(Boolean)
        .sort()
        .join(" ");
}

function setupFileNameDisplay(inputId, displayId) {
    const input = document.getElementById(inputId);
    const display = document.getElementById(displayId);
    if (!input || !display) return;
    const updateName = () => {
        if (input.files && input.files.length > 0) {
            display.textContent = input.files[0].name;
        } else {
            display.textContent = "No file selected";
        }
    };
    input.addEventListener("change", updateName);
}

// Extract money line after a label
function extractNextMoney(lines, idx) {
    for (let i = idx + 1; i < lines.length; i++) {
        if (/^\$[0-9,]+\.\d{2}$/.test(lines[i])) return lines[i];
    }
    return "";
}

// =========================
// 1. Extract PAYROLL employees
// =========================
async function extractPayroll(pdfFile) {

    const pdf = await pdfjsLib.getDocument({ data: await pdfFile.arrayBuffer() }).promise;
    const employees = [];

    for (let p = 1; p <= pdf.numPages; p++) {

        const page = await pdf.getPage(p);
        const txt = await page.getTextContent();
        const lines = txt.items.map(t => t.str.trim()).filter(t => t);

        // Payroll name format:  "Last, First"
        let first="", last="";
        let middle="";
        let firstForMatching="";
        if (lines[0].includes(",")) {
            let parts = lines[0].split(",");
            last = parts[0].trim();
            const rawFirst = parts[1].trim();
            first = rawFirst;
            firstForMatching = rawFirst;

            const tokens = rawFirst.split(/\s+/).filter(Boolean);
            const lastToken = tokens[tokens.length - 1];
            if (tokens.length >= 2 && lastToken && lastToken.length === 1) {
                first = tokens.slice(0, -1).join(" ");
                middle = lastToken.toUpperCase();
            }
        }

        let wages="", pit="";
        for (let i=0;i<lines.length;i++){
            if (lines[i] === "GROSS PAY") {
                wages = extractNextMoney(lines, i);
            }
            if (lines[i] === "CALIFORNIA STATE TAX") {
                pit = extractNextMoney(lines, i);
            }
        }

        if (!firstForMatching && first) firstForMatching = first;
        const matchName = cleanName(`${firstForMatching} ${last}`.trim());

        employees.push({
            first,
            middle,
            last,
            wages,
            pitWages: wages,
            pitWithheld: pit,
            ssn: "",
            fullName: matchName
        });
    }

    return employees;
}

// =========================
// 2. Extract W-2 employees
// =========================
async function extractW2(pdfFile) {

    const pdf = await pdfjsLib.getDocument({ data: await pdfFile.arrayBuffer() }).promise;
    const people = [];

    for (let p = 1; p <= pdf.numPages; p++) {

        const page = await pdf.getPage(p);
        const txt = await page.getTextContent();
        const lines = txt.items.map(t => t.str.trim()).filter(t => t);

        let ssn="", fullName="";

        for (let line of lines) {

            if (/^\d{3}-\d{2}-\d{4}$/.test(line)) {
                ssn = line.replace(/-/g, "");
            }

            if (/^[A-Za-z][A-Za-z .'-]+ [A-Za-z][A-Za-z .'-]+$/.test(line)
                && !line.includes("Form W-2")
                && !line.includes("Wage and Tax Statement")
                && !line.includes("FORCEPROTECTOR")
                && !line.match(/\bCA\b/)
                && !line.match(/^\d/)) {
                    fullName = line;
            }
        }

        if (ssn && fullName) {

            // split full name
            let parts = fullName.split(/\s+/);
            let first = parts[0];
            let last = parts.slice(1).join(" ");

            const cleaned = cleanName(first + " " + last);
            people.push({
                key: cleaned,
                fullName: cleaned,
                ssn,
                first,
                last
            });
        }
    }

    return people;
}

// =========================
// 3. MATCH BY NAME
// =========================
function matchByName(payroll, w2List) {

    const nameMap = {};
    const unmatchedIdx = new Set();

    w2List.forEach((w, idx) => {
        const key = w.fullName || w.key || cleanName(`${w.first} ${w.last}`);
        if (!nameMap[key]) nameMap[key] = [];
        nameMap[key].push({ ...w, idx });
        unmatchedIdx.add(idx);
    });

    const unmatchedPayroll = [];

    payroll.forEach(emp => {
        const key = emp.fullName || cleanName(`${emp.first} ${emp.last}`);
        const bucket = nameMap[key];

        if (bucket && bucket.length) {
            const match = bucket.shift();
            emp.ssn = match.ssn;
            unmatchedIdx.delete(match.idx);
        } else {
            emp.ssn = "";
            unmatchedPayroll.push({
                name: `${emp.first} ${emp.last}`.trim() || "(no name)",
                reason: "No W-2 entry with a matching name",
                emp
            });
        }
    });

    let unmatchedW2 = Array.from(unmatchedIdx).map(idx => {
        const w = w2List[idx];
        return {
            ssn: w.ssn,
            name: `${w.first} ${w.last}`.trim() || "(no name)",
            reason: "No payroll entry matched this W-2 name",
            wRef: w
        };
    });

    unmatchedPayroll.forEach(entry => {
        if (entry.emp.ssn) return;
        const payrollClean = cleanName(`${entry.emp.first} ${entry.emp.last}`);
        const candidates = unmatchedW2.filter(wEntry => {
            const wClean = cleanName(wEntry.name);
            return payrollClean && wClean &&
                (payrollClean.includes(wClean) || wClean.includes(payrollClean));
        });

        if (candidates.length === 1) {
            const chosen = candidates[0];
            entry.emp.ssn = chosen.ssn;
            unmatchedW2 = unmatchedW2.filter(item => item !== chosen);
        }
    });

    const cleanedUnmatchedPayroll = unmatchedPayroll.filter(entry => !entry.emp.ssn)
        .map(entry => ({
            name: entry.name,
            reason: entry.reason
        }));

    const cleanedUnmatchedW2 = unmatchedW2.map(entry => ({
        ssn: entry.ssn,
        name: entry.name,
        reason: entry.reason
    }));

    return { payroll, unmatchedPayroll: cleanedUnmatchedPayroll, unmatchedW2: cleanedUnmatchedW2 };
}

// =========================
// MAIN
// =========================
async function extractAll() {

    document.getElementById("log").textContent = "";

    const payrollFile = document.getElementById("payrollPDF").files[0];
    const w2File = document.getElementById("w2PDF").files[0];

    if (!payrollFile || !w2File) {
        alert("Please upload both PDFs.");
        return;
    }

    log("Extracting payroll…");
    const payroll = await extractPayroll(payrollFile);

    log("Extracting W-2 employees…");
    const w2people = await extractW2(w2File);

    log("Matching by name…");
    const matchResult = matchByName(payroll, w2people);
    const finalData = matchResult.payroll;
    const { unmatchedPayroll, unmatchedW2 } = matchResult;
    latestData = finalData;

    // render table
    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";

    const totals = {
        wages: 0,
        pitWages: 0,
        pitWithheld: 0,
        count: finalData.length
    };

    finalData.forEach((emp, idx) => {
        tbody.innerHTML += `
        <tr>
            <td><input type="text" value="${formatSSN(emp.ssn)}" data-idx="${idx}" size="12" oninput="updateSSN(this)"></td>
            <td>${emp.first}</td>
            <td>${emp.middle || ""}</td>
            <td>${emp.last}</td>
            <td>${emp.wages}</td>
            <td>${emp.pitWages}</td>
            <td>${emp.pitWithheld}</td>
        </tr>`;

        totals.wages += parseCurrency(emp.wages);
        totals.pitWages += parseCurrency(emp.pitWages);
        totals.pitWithheld += parseCurrency(emp.pitWithheld);
    });

    updateTotalsRow(totals);

    if (unmatchedPayroll.length === 0 && unmatchedW2.length === 0) {
        log("All employees matched successfully.");
    } else {
        if (unmatchedPayroll.length) {
            log("Payroll entries missing SSNs:");
            unmatchedPayroll.forEach(item => {
                log(` - ${item.name}: ${item.reason}`);
            });
        }
        if (unmatchedW2.length) {
            log("Unmatched W-2 SSNs:");
            unmatchedW2.forEach(item => {
                log(` - ${item.ssn} (${item.name}): ${item.reason}`);
            });
        }
    }

    log("Done.");
}

function updateSSN(inputEl) {
    const idx = parseInt(inputEl.dataset.idx, 10);
    if (!Number.isNaN(idx) && latestData[idx]) {
        const digits = inputEl.value.replace(/\D/g, "");
        latestData[idx].ssn = digits;
    }
}

setupFileNameDisplay("payrollPDF", "payrollFileName");
setupFileNameDisplay("w2PDF", "w2FileName");

function exportCSV() {
    if (!latestData.length) {
        alert("Run extraction first to populate data.");
        return;
    }

    const headers = ["SSN","First Name","Middle Name","Last Name","Total Subject Wages","PIT Wages","PIT Withheld"];
    const rows = latestData.map(emp => [
        formatSSN(emp.ssn),
        emp.first || "",
        emp.middle || "",
        emp.last || "",
        emp.wages || "",
        emp.pitWages || "",
        emp.pitWithheld || ""
    ]);

    const csv = [headers, ...rows]
        .map(row => row.map(value => `"${String(value).replace(/"/g, '""')}"`).join(","))
        .join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    const stamp = new Date().toISOString().slice(0,19).replace(/[-:T]/g, "");
    link.download = `payroll-w2-${stamp}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
